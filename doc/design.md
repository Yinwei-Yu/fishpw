# `fishpw` 密码本工具：设计与开发指导文档

## 1\. 项目概述

`fishpw` 是一个基于 Rust 开发的命令行（CLI）密码本工具，旨在为个人用户提供一个简洁、安全、易用的密码管理解决方案。本项目核心功能包括密码的增、删、改、查，以及安全地存储和管理敏感数据。

  * **核心目标**: 满足个人日常记录密码的需要，提供安全可靠的本地密码管理功能。
  * **受众**: 主要面向个人用户，未来考虑提供一定的扩展空间以支持少量用户分享。
  * **成功标准**: 能够稳定、安全地实现密码的增删改查、加密存储，并提供友好的命令行交互体验。

## 2\. 技术选型与依赖

本项目将完全基于 Rust 语言进行开发，利用其内存安全和性能优势，确保工具的稳定性和安全性。

### 2.1 核心技术栈

  * **编程语言**: Rust
  * **应用类型**: 单机命令行应用

### 2.2 核心第三方库

| 类别       | 库名           | 目的/功能                                       | 许可协议            | 需熟悉点                                                                                                 |
| :--------- | :------------- | :---------------------------------------------- | :------------------ | :------------------------------------------------------------------------------------------------------- |
| **CLI** | `clap`         | 命令行参数解析                                  | MIT License         | 定义子命令、参数、选项；获取用户输入。                                                                     |
|            | `dialoguer`    | 交互式命令行输入                                | MIT License         | 使用 `Input`、`Password`、`Confirm` 等进行交互式引导输入。                                            |
| **数据** | `rusqlite`     | SQLite 数据库操作                               | MIT License         | 打开/关闭连接；创建表；执行 SQL 查询（`INSERT`, `SELECT`, `UPDATE`, `DELETE`）；事务管理。             |
|            | `serde`        | Rust 数据结构序列化/反序列化                    | MIT OR Apache-2.0   | 为 `PasswordEntry` 和 `PasswordVault` 派生 `Serialize` 和 `Deserialize` 特性。                               |
|            | `uuid`         | UUID 生成                                       | MIT / Apache-2.0    | 生成版本 4 (随机) UUID。                                                                               |
| **加密** | `aes-gcm`      | AES-256 GCM 对称加密算法                        | MIT / Apache-2.0    | 生成安全的 IV；使用密钥和 IV 进行 `encrypt` 和 `decrypt`。                                                 |
|            | `argon2`       | Argon2 密钥派生函数 (KDF)                       | MIT / Apache-2.0    | 使用主密码、盐值和配置参数（内存、时间成本）派生密钥；理解 KDF 的重要性。                                  |
|            | `rand`         | 加密安全随机数生成                              | MIT / Apache-2.0    | 生成安全的随机字节序列，用于盐值和 IV。                                                                    |
| **安全** | `zeroize`      | 内存归零，安全擦除敏感数据                      | MIT / Apache-2.0    | 在敏感数据结构上派生 `Zeroize` 特性；或手动调用 `.zeroize()` 方法。                                        |
| **日志** | `log`          | 日志门面                                        | MIT / Apache-2.0    | 使用 `info!`, `error!` 等宏。                                                                            |
|            | `fern`         | 高级日志实现（文件输出、自定义格式）            | MIT / Apache-2.0    | 配置日志格式（时间、文件、行号）；将日志输出到文件；日志级别控制。                                       |
|            | `chrono`       | 时间处理，用于精确日志时间戳                      | MIT / Apache-2.0    | 获取当前时间并格式化。                                                                                   |
| **错误处理** | `anyhow`       | 简化错误传播与处理                              | MIT / Apache-2.0    | 统一应用程序层面的错误处理。                                                                             |
|            | `thiserror`    | 定义自定义错误类型（可选）                        | MIT / Apache-2.0    | 结构化自定义错误。                                                                                       |
| **测试** | `assert_cmd`   | 命令行测试工具（集成测试）                      | MIT License         | 模拟命令行输入和断言输出。                                                                               |
|            | `predicates`   | 灵活的断言库（集成测试）                        | MIT License         | 匹配命令行输出。                                                                                         |
|            | `tempfile`     | 创建临时文件和目录（测试用）                    | MIT License         | 确保测试环境隔离，不污染实际文件系统。                                                                     |
|            | `dirs`         | 跨平台获取用户目录（日志文件路径）                | MIT / Apache-2.0    | 用于 `setup_logging` 函数中获取日志文件路径。                                                            |

## 3\. 项目架构设计

`fishpw` 项目将采用模块化架构，职责分离，以提高可维护性、可测试性和安全性。

### 3.1 模块划分

  * **`CLI/UI` 模块**: 负责用户交互、命令行参数解析、交互式输入以及向用户展示输出。
      * **职责**: 解析 `clap` 定义的子命令和参数；通过 `dialoguer` 引导用户输入敏感和非敏感数据；格式化 `Core Logic` 返回的结果并输出到终端。
      * **依赖**: `Core Logic`、`clap`、`dialoguer`。
  * **`Core Logic` 模块**: 封装核心业务逻辑，协调各模块完成用户请求。
      * **职责**: 接收 `CLI/UI` 的请求；管理密码库的解锁状态；协调 `Data Store` 和 `Encryption` 模块进行数据操作；处理密码生成和剪贴板操作。
      * **依赖**: `Data Store`、`Encryption`。
  * **`Data Store` 模块**: 负责数据在内存与 SQLite 数据库之间的持久化。
      * **职责**: 管理 SQLite 数据库连接；执行 `INSERT`, `SELECT`, `UPDATE`, `DELETE` 等 SQL 操作；存储和检索加密后的字节流数据和元数据。
      * **依赖**: `rusqlite`、`serde`。
  * **`Encryption` 模块**: 专注于所有加密和解密操作，是项目的安全核心。
      * **职责**: 使用 Argon2 从主密码派生对称加密密钥；使用 AES-256 GCM 进行数据加密和解密；生成安全的随机盐值和 IV。
      * **依赖**: `aes-gcm`、`argon2`、`rand`。
  * **`Security Utilities` 模块**: 提供通用的安全辅助功能。
      * **职责**: 实现敏感数据在内存中归零 (`zeroize`)。
      * **依赖**: `zeroize`。
  * **`Utils` 模块 (新增)**: 存放通用的辅助函数，例如日志初始化、文件路径管理等。
      * **职责**: 初始化 `fern` 日志系统；获取跨平台兼容的日志文件路径。
      * **依赖**: `log`、`fern`、`chrono`、`dirs`。

### 3.2 数据结构

```rust
#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct PasswordEntry {
    pub uuid: String,            // 唯一标识符，如 "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
    pub service: String,         // 服务的名称或来源
    pub account: String,         // 账号名或用户名
    pub encrypted_password: Vec<u8>, // 加密后的密码数据（密文+tag），存储为字节数组
    pub url: Option<String>,     // 可选：对应服务的网址
    pub notes: Option<String>,   // 可选：备注
    pub tags: Vec<String>,       // 可选：用于分类和查找的标签
    pub created_at: i64,         // 创建时间戳（Unix epoch seconds 或 milliseconds）
    pub updated_at: i64,         // 修改时间戳
    pub iv: Vec<u8>,             // 每个PasswordEntry加密时使用的独立IV
}

// PasswordVault 主要用于存储密码库的元数据，不直接存储所有PasswordEntry
// PasswordEntry 将直接存储在 SQLite 中
#[derive(Debug, serde::Serialize, serde::Deserialize)]
pub struct PasswordVaultMetadata {
    pub salt: Vec<u8>,        // 用于 KDF 的盐值
    pub kdf_params: String,   // 存储 KDF 参数（如 Argon2 的内存、时间、并行度等）
    // 其他全局元数据，如版本信息等
}
```

  * **说明**:
      * `PasswordEntry` 中的 `encrypted_password` 将包含 AES-GCM 的密文和认证标签。
      * 为每个 `PasswordEntry` 引入独立的 `iv` 字段，确保每个密码条目的加密过程是独立的，增强安全性。
      * `PasswordVaultMetadata` 用于存储整个密码库的全局元数据，如 KDF 相关的盐值和参数，这些将存储在 SQLite 数据库的一个单独的配置表或特殊记录中。`PasswordEntry` 实例将直接作为行存储在 SQLite 数据库中。

### 3.3 数据流示例：添加新密码

1.  **用户**在命令行输入 `fishpw add`。
2.  `CLI/UI` 模块接收命令，通过 `dialoguer` 提示用户输入**服务名、账号、明文密码、网址、备注**等信息。
3.  `CLI/UI` 将这些明文信息传递给 `Core Logic` 模块。
4.  `Core Logic` 模块首先检查用户是否已解锁密码本（通过验证主密码），并获取**派生出的加密密钥**。
5.  `Core Logic` 模块将**明文密码**和**派生密钥**发送给 `Encryption` 模块。
6.  `Encryption` 模块生成一个**新的随机 IV**，并使用**派生密钥**和 **IV** 对**明文密码**进行加密，返回**加密后的密码数据 (`Vec<u8>`)** 和 **IV**。
7.  `Core Logic` 模块将**服务名、账号、加密后的密码数据、IV** 以及其他元数据（创建时间、标签等）封装成一个 `PasswordEntry` 对象。
8.  `Core Logic` 模块将 `PasswordEntry` 对象传递给 `Data Store` 模块。
9.  `Data Store` 模块将 `PasswordEntry` 对象的字段写入到 SQLite 数据库中。
10. `Data Store` 模块返回操作结果给 `Core Logic`。
11. `Core Logic` 返回结果给 `CLI/UI`。
12. `CLI/UI` 向用户显示“密码添加成功”或错误信息。
13. **重要**: 在整个过程中，一旦明文密码不再需要，应立即通过 `Security Utilities` 模块将其从内存中**归零**。

## 4\. 用户体验与界面 (UX/UI)

`fishpw` 将提供一个简洁、直观的命令行交互体验，专注于核心的增删改查功能。

### 4.1 界面设计理念

  * **命令行友好**: 所有操作通过命令行命令和参数完成。
  * **简洁易用**: 界面无额外图形元素，专注于核心功能，不旁生枝叶。
  * **交互式引导**: 对于添加、修改等复杂操作，采用交互式输入模式，逐项引导用户，提供默认值和必填校验。

### 4.2 用户使用流程

#### 4.2.1 初次使用：设置主密码与创建密码库

  * **检测**: `fishpw` 启动时检测密码库文件是否存在。
  * **提示创建**: 若不存在，提示 `未检测到密码库。是否创建新的密码库？(Y/n)`。
  * **设置主密码**: 引导用户输入并再次确认主密码（输入时不可见）。
  * **反馈**: 成功则 `密码库已成功创建！`，失败则 `两次密码输入不匹配，请重试。`

#### 4.2.2 日常使用：解锁密码库

  * **提示解锁**: ` 请输入主密码解锁密码库 (输入时不可见):  `
  * **密码验证**: 使用主密码解密密码库。
  * **反馈**: 成功则 `密码库已解锁。您现在可以管理您的密码了。`，失败则 `主密码错误，请重试。`（可选限制尝试次数）。

#### 4.2.3 核心功能操作：增、删、改、查

  * **a) 增加 (Add) 密码条目**
      * **命令**: `fishpw add`
      * **交互式流程**: 引导输入“服务名称 (必填)”、“账号/用户名 (必填)”、“密码 (可选生成或手动输入)”、“网址 (可选)”、“备注 (可选)”。
      * **反馈**: `密码条目 'Service Name' 已成功添加！`
  * **b) 查找 (Find) 密码条目**
      * **命令**: `fishpw find <关键词>` 或 `fishpw find --service <服务名>`
      * **流程**: 模糊查找匹配条目。
      * **结果显示**: 0 条则 `未找到匹配...`；1 条则显示非敏感信息并提示复制密码命令；多条则列出简要信息（服务、账号、UUID）供用户选择查看详情。
      * **复制密码**: `fishpw copy <UUID>` 将解密后的密码临时复制到剪贴板，并提示 `密码已复制到剪贴板，将在 30 秒后自动清除。`
  * **c) 修改 (Edit) 密码条目**
      * **命令**: `fishpw edit <UUID>`
      * **交互式流程**: 加载条目，显示当前值作为默认值，逐项引导用户修改。密码修改将触发新的密码输入流程。
      * **反馈**: `密码条目 'Service Name' 已成功更新！`
  * **d) 删除 (Delete) 密码条目**
      * **命令**: `fishpw delete <UUID>`
      * **流程**: 显示待删除条目简要信息。
      * **二次确认**: `您确定要删除此密码条目吗？(Y/n)`
      * **反馈**: `密码条目 'Service Name' 已成功删除！`

### 4.3 错误处理与反馈机制

  * **原则**: 及时、清晰、具体、友好，并提供指引。
  * **常见错误处理**:
      * **主密码错误**: `主密码不正确，请重试。`
      * **两次主密码不匹配**: `两次密码输入不匹配，请重试。`
      * **必填字段为空**: `[字段名] 不能为空，请重新输入。`
      * **密码强度过低**: `警告：您输入的密码强度较低，建议使用更复杂的密码。是否继续使用此密码？(Y/n)`
      * **无效 UUID/条目不存在**: `未找到 UUID 为 'xxxx' 的密码条目。`
      * **文件/数据库操作错误**: `错误：[具体错误]。请检查权限/完整性/空间。`
      * **用户取消操作**: `操作已取消。`
      * **内部错误/未知错误**: `抱歉，发生了一个内部错误：[简要描述]。请尝试重启或报告。` （内部记录日志）

## 5\. 部署与维护

### 5.1 项目发布与部署

  * **打包**: 使用 `cargo build --release` 生成优化过的独立二进制文件。
  * **跨平台**: 通过 Rust 的交叉编译支持 (`rustup target add <target_triple>`)，编译适用于 Windows、macOS 和 Linux 的二进制文件。
  * **分发**: 主要通过 **GitHub Releases** 页面发布预编译的二进制文件（打包为 `.zip` 或 `.tar.gz`）。未来可考虑 Homebrew 或 Cargo 安装。

### 5.2 更新与迭代

  * **版本控制**: 全程使用 Git 进行版本控制。
  * **版本规范**: 遵循 Semantic Versioning (SemVer) (`MAJOR.MINOR.PATCH`)。
  * **更新策略**: 根据用户反馈和需求，定期发布新版本。初期主要依赖用户手动下载替换或通过 `cargo install --force` 更新。
  * **功能迭代**: 坚持 MVP (最小可行产品) 原则，逐步添加新功能，如更强大的密码生成器、标签管理、甚至探索基于文件同步的简单多端同步方案。

### 5.3 错误处理与崩溃日志

  * **日志系统**: 使用 `fern` 库实现详细的日志记录。
  * **日志输出**:
      * 日志将写入到指定的文件（例如，用户配置目录下的 `fishpw/fishpw.log`）。
      * 日志级别将根据 `INFO`, `WARN`, `ERROR` 进行区分，确保关键信息被记录。
  * **日志内容**: 每条日志将包含：
      * **时间戳**: 精确到毫秒 (`chrono` 库支持)。
      * **文件路径**: 发生日志写入行为的 Rust 源文件绝对路径。
      * **行号**: 发生日志写入行为的源代码行号。
      * **日志级别**: `INFO`, `WARN`, `ERROR`, `DEBUG`, `TRACE`。
      * **模块路径**: 日志发生的模块（`record.target()`）。
      * **日志内容**: 具体的日志消息。
  * **错误报告**: 鼓励用户在遇到错误时，复制终端输出的错误信息，并结合日志文件内容，提交到 GitHub Issues。

### 5.4 用户反馈机制

  * **平台**: 主要通过 **GitHub Issues** 收集用户反馈。
      * **Bug 报告**: 用户提交遇到的 Bug 及重现步骤。
      * **功能请求**: 用户提出新的功能需求。
  * **引导**: 在 `README.md` 中明确说明反馈途径，并在命令行工具的帮助信息或错误提示中引导用户。
  * **响应**: 积极、及时地响应用户反馈，提升用户参与度和满意度。

## 6\. 文档与测试 (质量保障)

### 6.1 代码注释与项目文档

  * **代码注释**:
      * **`///` (文档注释)**: 用于公共（`pub`）项，解释其用途、参数、返回值。LLM 可辅助生成初稿，但需**人工审查和补充**。
      * **`//` (行注释)**: 解释复杂代码块的实现细节、算法思路或设计决策的“为什么”。
  * **项目文档**:
      * **`README.md`**: 项目门面，包含简介、功能、安装、使用示例、安全性说明、错误处理、反馈途径和许可证等。LLM 可辅助生成，但需**人工审查和定制**。
      * **其他 Markdown 文件**: 如 `CONTRIBUTING.md` 或 `docs/` 目录，用于更详细的指南或设计文档（可选）。

### 6.2 测试策略

  * **单元测试 (Unit Tests)**:
      * **目的**: 测试代码的最小独立单元（函数/方法），确保其按预期工作。
      * **覆盖范围**: 核心加密函数（加解密一致性、KDF 验证）、数据结构操作、字符串处理、密码生成器等。
      * **实践**: 与代码同文件，在 `mod tests { ... }` 块中，使用 `#[test]` 和 `assert!` 系列宏。
  * **集成测试 (Integration Tests)**:
      * **目的**: 测试不同模块协同工作的情况，模拟真实用户场景。
      * **覆盖范围**: 完整的用户工作流（如增-\>查-\>改-\>删）、数据库交互的正确性、所有错误场景的处理（文件权限、数据库损坏、主密码错误等）。
      * **实践**: 放在项目根目录下的 `tests/` 目录中，使用 `assert_cmd`, `predicates`, `tempfile` 等库。
  * **安全相关测试的重要性**:
      * **加密/解密一致性**: 验证加密数据能正确解密，且加密过程是随机的。
      * **KDF 验证**: 验证 KDF 从相同主密码和盐值派生出相同的密钥。
      * **内存归零**: 确保敏感数据在使用后从内存中安全擦除（通过单元测试模拟和代码审查）。
      * **边界条件和异常**: 测试空主密码、无效主密码、文件损坏等。

